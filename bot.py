#!/usr/bin/env python
# -*- coding: utf-8 -*-

import logging
import os
import time
import requests
import psycopg2

from telegram import (
    Update,
    InlineKeyboardButton,
    InlineKeyboardMarkup
)
from telegram.ext import (
    Updater,
    CommandHandler,
    MessageHandler,
    Filters,
    CallbackQueryHandler,
    CallbackContext
)

###############################################################################
# ุงูุฅุนุฏุงุฏุงุช ุงูุนุงูุฉ ูุงูุณุฌู (Logging)
###############################################################################
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

###############################################################################
# ูุชุบูุฑุงุช ุงูุจูุฆุฉ (Environment Variables)
# ูุฌุจ ุถุจุท ูุฐู ุงูููู ูู ุงูููุฑููู (ุฃู ุฃู ููุตุฉ ุฃุฎุฑู):
# - ADMIN_ID
# - TOKEN
# - API_KEY
# - API_URL
# - NEON_DATABASE_URL
###############################################################################
ADMIN_ID = int(os.environ.get("ADMIN_ID", "0"))
TOKEN = os.environ.get("TOKEN")
API_KEY = os.environ.get("API_KEY")
API_URL = os.environ.get("API_URL")
NEON_DATABASE_URL = os.environ.get("NEON_DATABASE_URL")

if not TOKEN:
    raise Exception("ูู ูุชู ุชุนููู ูุชุบูุฑ ุงูุจูุฆุฉ TOKEN.")
if not API_KEY:
    raise Exception("ูู ูุชู ุชุนููู ูุชุบูุฑ ุงูุจูุฆุฉ API_KEY.")
if not API_URL:
    raise Exception("ูู ูุชู ุชุนููู ูุชุบูุฑ ุงูุจูุฆุฉ API_URL.")
if not NEON_DATABASE_URL:
    raise Exception("ูู ูุชู ุชุนููู ูุชุบูุฑ ุงูุจูุฆุฉ NEON_DATABASE_URL.")

###############################################################################
# ุงูููุงููุณ ุงูุฎุงุตุฉ ุจุงูุฎุฏูุงุช
###############################################################################
service_api_mapping = {
    "ูุชุงุจุนูู ุชููุชูู 1k": {"service_id": 13912, "quantity_multiplier": 1000},
    "ูุชุงุจุนูู ุชููุชูู 2k": {"service_id": 13912, "quantity_multiplier": 2000},
    "ูุชุงุจุนูู ุชููุชูู 3k": {"service_id": 13912, "quantity_multiplier": 3000},
    "ูุชุงุจุนูู ุชููุชูู 4k": {"service_id": 13912, "quantity_multiplier": 4000},

    "ูุดุงูุฏุงุช ุชููุชูู 1k":  {"service_id": 9543, "quantity_multiplier": 1000},
    "ูุดุงูุฏุงุช ุชููุชูู 10k": {"service_id": 9543, "quantity_multiplier": 10000},
    "ูุดุงูุฏุงุช ุชููุชูู 20k": {"service_id": 9543, "quantity_multiplier": 20000},
    "ูุดุงูุฏุงุช ุชููุชูู 30k": {"service_id": 9543, "quantity_multiplier": 30000},
    "ูุดุงูุฏุงุช ุชููุชูู 50k": {"service_id": 9543, "quantity_multiplier": 50000},

    "ูุชุงุจุนูู ุงูุณุชุบุฑุงู 1k": {"service_id": 13788, "quantity_multiplier": 1000},
    "ูุชุงุจุนูู ุงูุณุชุบุฑุงู 2k": {"service_id": 13788, "quantity_multiplier": 2000},
    "ูุชุงุจุนูู ุงูุณุชุบุฑุงู 3k": {"service_id": 13788, "quantity_multiplier": 3000},
    "ูุชุงุจุนูู ุงูุณุชุบุฑุงู 4k": {"service_id": 13788, "quantity_multiplier": 4000},

    "ูุงููุงุช ุชููุชูู 1k": {"service_id": 12320, "quantity_multiplier": 1000},
    "ูุงููุงุช ุชููุชูู 2k": {"service_id": 12320, "quantity_multiplier": 2000},
    "ูุงููุงุช ุชููุชูู 3k": {"service_id": 12320, "quantity_multiplier": 3000},
    "ูุงููุงุช ุชููุชูู 4k": {"service_id": 12320, "quantity_multiplier": 4000},

    "ูุงููุงุช ุงูุณุชุบุฑุงู 1k": {"service_id": 7973, "quantity_multiplier": 1000},
    "ูุงููุงุช ุงูุณุชุบุฑุงู 2k": {"service_id": 7973, "quantity_multiplier": 2000},
    "ูุงููุงุช ุงูุณุชุบุฑุงู 3k": {"service_id": 7973, "quantity_multiplier": 3000},
    "ูุงููุงุช ุงูุณุชุบุฑุงู 4k": {"service_id": 7973, "quantity_multiplier": 4000},

    "ูุดุงูุฏุงุช ุงูุณุชุบุฑุงู 10k": {"service_id": 13531, "quantity_multiplier": 10000},
    "ูุดุงูุฏุงุช ุงูุณุชุบุฑุงู 20k": {"service_id": 13531, "quantity_multiplier": 20000},
    "ูุดุงูุฏุงุช ุงูุณุชุบุฑุงู 30k": {"service_id": 13531, "quantity_multiplier": 30000},
    "ูุดุงูุฏุงุช ุงูุณุชุบุฑุงู 50k": {"service_id": 13531, "quantity_multiplier": 50000},

    "ูุดุงูุฏุงุช ุจุซ ุชููุชูู 1k": {"service_id": 13813, "quantity_multiplier": 1000},
    "ูุดุงูุฏุงุช ุจุซ ุชููุชูู 2k": {"service_id": 13813, "quantity_multiplier": 2000},
    "ูุดุงูุฏุงุช ุจุซ ุชููุชูู 3k": {"service_id": 13813, "quantity_multiplier": 3000},
    "ูุดุงูุฏุงุช ุจุซ ุชููุชูู 4k": {"service_id": 13813, "quantity_multiplier": 4000},

    "ูุดุงูุฏุงุช ุจุซ ุงูุณุชุบุฑุงู 1k": {"service_id": 12595, "quantity_multiplier": 1000},
    "ูุดุงูุฏุงุช ุจุซ ุงูุณุชุบุฑุงู 2k": {"service_id": 12595, "quantity_multiplier": 2000},
    "ูุดุงูุฏุงุช ุจุซ ุงูุณุชุบุฑุงู 3k": {"service_id": 12595, "quantity_multiplier": 3000},
    "ูุดุงูุฏุงุช ุจุซ ุงูุณุชุบุฑุงู 4k": {"service_id": 12595, "quantity_multiplier": 4000},

    "ููุงุท ุชุญุฏูุงุช ุชูู ุชูู ุฌุฏูุฏุฉ | ุณููุฑ ๐ฏ": {"service_id": 13125, "quantity_multiplier": 1000},
    "ุฑูุน ุณููุฑ ุจุซู1k": {"service_id": 13125, "quantity_multiplier": 1000},
    "ุฑูุน ุณููุฑ ุจุซู2k": {"service_id": 13125, "quantity_multiplier": 2000},
    "ุฑูุน ุณููุฑ ุจุซู3k": {"service_id": 13125, "quantity_multiplier": 3000},
    "ุฑูุน ุณููุฑ ุจุซู10k": {"service_id": 13125, "quantity_multiplier": 10000},
}

services_dict = {
    "ูุชุงุจุนูู ุชููุชูู 1k": 3.50,
    "ูุชุงุจุนูู ุชููุชูู 2k": 7,
    "ูุชุงุจุนูู ุชููุชูู 3k": 10.50,
    "ูุชุงุจุนูู ุชููุชูู 4k": 14,

    "ูุดุงูุฏุงุช ุชููุชูู 1k": 0.10,
    "ูุดุงูุฏุงุช ุชููุชูู 10k": 0.80,
    "ูุดุงูุฏุงุช ุชููุชูู 20k": 1.60,
    "ูุดุงูุฏุงุช ุชููุชูู 30k": 2.40,
    "ูุดุงูุฏุงุช ุชููุชูู 50k": 3.20,

    "ูุชุงุจุนูู ุงูุณุชุบุฑุงู 1k": 3,
    "ูุชุงุจุนูู ุงูุณุชุบุฑุงู 2k": 6,
    "ูุชุงุจุนูู ุงูุณุชุบุฑุงู 3k": 9,
    "ูุชุงุจุนูู ุงูุณุชุบุฑุงู 4k": 12,

    "ูุงููุงุช ุชููุชูู 1k": 1,
    "ูุงููุงุช ุชููุชูู 2k": 2,
    "ูุงููุงุช ุชููุชูู 3k": 3,
    "ูุงููุงุช ุชููุชูู 4k": 4,

    "ูุงููุงุช ุงูุณุชุบุฑุงู 1k": 1,
    "ูุงููุงุช ุงูุณุชุบุฑุงู 2k": 2,
    "ูุงููุงุช ุงูุณุชุบุฑุงู 3k": 3,
    "ูุงููุงุช ุงูุณุชุบุฑุงู 4k": 4,

    "ูุดุงูุฏุงุช ุงูุณุชุบุฑุงู 10k": 0.80,
    "ูุดุงูุฏุงุช ุงูุณุชุบุฑุงู 20k": 1.60,
    "ูุดุงูุฏุงุช ุงูุณุชุบุฑุงู 30k": 2.40,
    "ูุดุงูุฏุงุช ุงูุณุชุบุฑุงู 50k": 3.20,

    "ูุดุงูุฏุงุช ุจุซ ุชููุชูู 1k": 2,
    "ูุดุงูุฏุงุช ุจุซ ุชููุชูู 2k": 4,
    "ูุดุงูุฏุงุช ุจุซ ุชููุชูู 3k": 6,
    "ูุดุงูุฏุงุช ุจุซ ุชููุชูู 4k": 8,

    "ูุดุงูุฏุงุช ุจุซ ุงูุณุชุบุฑุงู 1k": 2,
    "ูุดุงูุฏุงุช ุจุซ ุงูุณุชุบุฑุงู 2k": 4,
    "ูุดุงูุฏุงุช ุจุซ ุงูุณุชุบุฑุงู 3k": 6,
    "ูุดุงูุฏุงุช ุจุซ ุงูุณุชุบุฑุงู 4k": 8,

    "ููุงุท ุชุญุฏูุงุช ุชูู ุชูู ุฌุฏูุฏุฉ | ุณููุฑ ๐ฏ": 0.51,
    "ุฑูุน ุณููุฑ ุจุซู1k": 2,
    "ุฑูุน ุณููุฑ ุจุซู2k": 4,
    "ุฑูุน ุณููุฑ ุจุซู3k": 6,
    "ุฑูุน ุณููุฑ ุจุซู10k": 20,
}

pubg_services = {
    "ุจุจุฌู 60 ุดุฏุฉ": 2,
    "ุจุจุฌู 120 ุดุฏู": 4,
    "ุจุจุฌู 180 ุดุฏุฉ": 6,
    "ุจุจุฌู 240 ุดุฏุฉ": 8,
    "ุจุจุฌู 325 ุดุฏุฉ": 9,
    "ุจุจุฌู 660 ุดุฏุฉ": 15,
    "ุจุจุฌู 1800 ุดุฏุฉ": 40,
}

itunes_services = {
    "ุดุฑุงุก ุฑุตูุฏ 5 ุงูุชููุฒ": 9,
    "ุดุฑุงุก ุฑุตูุฏ 10 ุงูุชููุฒ": 18,
    "ุดุฑุงุก ุฑุตูุฏ 15 ุงูุชููุฒ": 27,
    "ุดุฑุงุก ุฑุตูุฏ 20 ุงูุชููุฒ": 36,
    "ุดุฑุงุก ุฑุตูุฏ 25 ุงูุชููุฒ": 45,
    "ุดุฑุงุก ุฑุตูุฏ 30 ุงูุชููุฒ": 54,
    "ุดุฑุงุก ุฑุตูุฏ 35 ุงูุชููุฒ": 63,
    "ุดุฑุงุก ุฑุตูุฏ 40 ุงูุชููุฒ": 72,
    "ุดุฑุงุก ุฑุตูุฏ 45 ุงูุชููุฒ": 81,
    "ุดุฑุงุก ุฑุตูุฏ 50 ุงูุชููุฒ": 90,
}

telegram_services = {
    "ุงุนุถุงุก ูููุงุช ุชูู 1k": 3,
    "ุงุนุถุงุก ูููุงุช ุชูู 2k": 6,
    "ุงุนุถุงุก ูููุงุช ุชูู 3k": 9,
    "ุงุนุถุงุก ูููุงุช ุชูู 4k": 12,
    "ุงุนุถุงุก ูููุงุช ุชูู 5k": 15,
    "ุงุนุถุงุก ูุฑูุจุงุช ุชูู 1k": 3,
    "ุงุนุถุงุก ูุฑูุจุงุช ุชูู 2k": 6,
    "ุงุนุถุงุก ูุฑูุจุงุช ุชูู 3k": 9,
    "ุงุนุถุงุก ูุฑูุจุงุช ุชูู 4k": 12,
    "ุงุนุถุงุก ูุฑูุจุงุช ุชูู 5k": 15,
}

###############################################################################
# ูุชุบูุฑุงุช ุงูุฐุงูุฑุฉ ููุทูุจุงุช ูุงูุฑุตูุฏ
###############################################################################
users_balance = {}
pending_orders = []         # ุงูุทูุจุงุช ุงููุนููุฉ (ุงูุฎุฏูุงุช ุงูุชู ูุง ุชูุฑุณู ูุจุงุดุฑุฉ ููู API)
pending_cards = []          # ุฃุฑูุงู ุงููุฑูุช ุงููุนููุฉ
pending_pubg_orders = []    # ุทูุจุงุช ุดุฏุงุช ุจุจุฌู ุงููุนููุฉ
completed_orders = []       # ุงูุทูุจุงุช ุงูููุชููุฉ (ูุน ุญูุธ ููุช ุงูุฅููุงู)
pending_itunes_orders = []  # ุทูุจุงุช ุดุญู ุงูุงูุชููุฒ ุงููุนููุฉ
blocked_users = {}          # ูุงููุณ ุงููุณุชุฎุฏููู ุงููุญุธูุฑูู

###############################################################################
# ุฅุนุฏุงุฏ ุงุชุตุงู ูุงุนุฏุฉ ุจูุงูุงุช (Neon) ุจุงุณุชุฎุฏุงู psycopg2
###############################################################################
conn = psycopg2.connect(NEON_DATABASE_URL, sslmode="require")
cursor = conn.cursor()

# ุฅูุดุงุก ุฌุฏูู ุงููุณุชุฎุฏููู ุฅู ูู ููู ููุฌูุฏุงู
cursor.execute("""
CREATE TABLE IF NOT EXISTS users (
    user_id BIGINT PRIMARY KEY,
    full_name TEXT,
    username TEXT,
    balance REAL DEFAULT 0
)
""")
conn.commit()

# ุงูุชุฃูุฏ ูู ุชููุฑ ุงูุฃุนูุฏุฉ ุงููุงุฒูุฉ
required_columns = {
    "full_name": "TEXT",
    "username": "TEXT",
    "balance": "REAL DEFAULT 0"
}
cursor.execute(
    "SELECT column_name FROM information_schema.columns WHERE table_name = 'users';"
)
existing_cols_info = cursor.fetchall()
existing_col_names = [col[0] for col in existing_cols_info]

for col_name, col_def in required_columns.items():
    if col_name not in existing_col_names:
        alter_stmt = f"ALTER TABLE users ADD COLUMN {col_name} {col_def}"
        cursor.execute(alter_stmt)
        conn.commit()

###############################################################################
# ุฏูุงู ุงูุชุนุงูู ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช
###############################################################################
def get_user_from_db(user_id):
    """ุฅุฑุฌุงุน ุณุฌู ูุณุชุฎุฏู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช."""
    cursor.execute("SELECT user_id, full_name, username, balance FROM users WHERE user_id=%s", (user_id,))
    return cursor.fetchone()

def add_user_to_db(user_id, full_name, username):
    """ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ ุฅูู ุฌุฏูู users ุฅุฐุง ูู ููู ููุฌูุฏุงู."""
    row = get_user_from_db(user_id)
    if not row:
        cursor.execute(
            "INSERT INTO users (user_id, full_name, username, balance) VALUES (%s, %s, %s, %s)",
            (user_id, full_name, username, 0.0)
        )
        conn.commit()

def update_user_balance_in_db(user_id, balance):
    """ุชุญุฏูุซ ุฑุตูุฏ ูุณุชุฎุฏู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช."""
    cursor.execute("UPDATE users SET balance=%s WHERE user_id=%s", (balance, user_id))
    conn.commit()

def update_username_in_db(user_id, username):
    """ุชุญุฏูุซ ุงุณู ุงููุณุชุฎุฏู (ุงูููุฒุฑููู) ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช."""
    cursor.execute("UPDATE users SET username=%s WHERE user_id=%s", (username, user_id))
    conn.commit()

def get_all_users():
    """ุฌูุจ ุฌููุน ุงููุณุชุฎุฏููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช."""
    cursor.execute("SELECT user_id, full_name, username, balance FROM users")
    return cursor.fetchall()

def get_users_with_balance_desc():
    """ุฌูุจ ุฌููุน ุงููุณุชุฎุฏููู ุฐูู ุงูุฑุตูุฏ > 0 ูุชุฑุชูุจูู ุจุดูู ุชูุงุฒูู ุจุญุณุจ ุงูุฑุตูุฏ."""
    cursor.execute(
        "SELECT user_id, full_name, username, balance FROM users WHERE balance > 0 ORDER BY balance DESC"
    )
    return cursor.fetchall()

def sync_balance_from_db(user_id):
    """ูุฒุงููุฉ ุงูุฑุตูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฅูู ุงูุฐุงูุฑุฉ."""
    row = get_user_from_db(user_id)
    if row:
        users_balance[user_id] = row[3]
    else:
        # ูู ุญุงู ูู ููู ุงููุณุชุฎุฏู ููุฌูุฏุงู ูู DBุ ุฃุจูู ูู ุงูุฐุงูุฑุฉ ุจุงููููุฉ ุงูููุฌูุฏุฉ ุฃู ุตูุฑ
        users_balance[user_id] = users_balance.get(user_id, 0.0)

def sync_balance_to_db(user_id):
    """ุญูุธ ุงูุฑุตูุฏ ูู ุงูุฐุงูุฑุฉ ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช."""
    bal = users_balance.get(user_id, 0.0)
    row = get_user_from_db(user_id)
    if row:
        update_user_balance_in_db(user_id, bal)
    else:
        add_user_to_db(user_id, "Unknown", "NoUsername")
        update_user_balance_in_db(user_id, bal)

###############################################################################
# ููุญุงุช ุงูููุงุชูุญ ุงูุฎุงุตุฉ ุจุงูุจูุช
###############################################################################
def main_menu_keyboard(user_id):
    """ููุญุฉ ุงูููุงุชูุญ ุงูุฑุฆูุณูุฉุ ุชุฎุชูู ูููุงูู ุนู ุงููุณุชุฎุฏู ุงูุนุงุฏู."""
    if user_id == ADMIN_ID:
        buttons = [
            [InlineKeyboardButton("ููุญุฉ ุชุญูู ุงููุงูู", callback_data="admin_menu")]
        ]
    else:
        buttons = [
            [InlineKeyboardButton("ุงูุฎุฏูุงุช", callback_data="show_services")],
            [InlineKeyboardButton("ุฑุตูุฏู", callback_data="show_balance")]
        ]
    return InlineKeyboardMarkup(buttons)

def admin_menu_keyboard():
    """ููุญุฉ ุชุญูู ุงููุงูู."""
    buttons = [
        [InlineKeyboardButton("ุญุถุฑ ุงููุณุชุฎุฏู", callback_data="block_user"),
         InlineKeyboardButton("ุงูุบุงุก ุญุธุฑ ุงููุณุชุฎุฏู", callback_data="unblock_user")],

        [InlineKeyboardButton("ุฅุถุงูุฉ ุงูุฑุตูุฏ", callback_data="admin_add_balance"),
         InlineKeyboardButton("ุฎุตู ุงูุฑุตูุฏ", callback_data="admin_discount")],

        [InlineKeyboardButton("ุนุฏุฏ ุงููุณุชุฎุฏููู", callback_data="admin_users_count"),
         InlineKeyboardButton("ุฑุตูุฏ ุงููุณุชุฎุฏููู", callback_data="admin_users_balance")],

        [InlineKeyboardButton("ูุฑุงุฌุนุฉ ุงูุทูุจุงุช", callback_data="review_orders"),
         InlineKeyboardButton("ุงููุงุฑุชุงุช ุงููุนููุฉ", callback_data="pending_cards")],

        [InlineKeyboardButton("ุทูุจุงุช ุดุฏุงุช ุจุจุฌู", callback_data="pending_pubg_orders"),
         InlineKeyboardButton("ูุญุต ุฑุตูุฏ API", callback_data="api_check_balance")],

        [InlineKeyboardButton("ูุญุต ุญุงูุฉ ุทูุจ API", callback_data="api_order_status"),
         InlineKeyboardButton("ุงุนูุงู ุงูุจูุช", callback_data="admin_announce")],

        [InlineKeyboardButton("ุทูุจุงุช ุดุญู ุงูุงูุชููุฒ", callback_data="pending_itunes_orders")],
        [InlineKeyboardButton("ุฑุฌูุน", callback_data="back_main")],
    ]
    return InlineKeyboardMarkup(buttons)

def services_menu_keyboard():
    """ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ ูุฎุฏูุงุช ุงูุฑุดู ูุงูุดุญู."""
    buttons = [
        [InlineKeyboardButton("ูุณู ุงููุชุงุจุนูู", callback_data="show_followers")],
        [InlineKeyboardButton("ูุณู ุงููุงููุงุช", callback_data="show_likes")],
        [InlineKeyboardButton("ูุณู ุงููุดุงูุฏุงุช", callback_data="show_views")],
        [InlineKeyboardButton("ูุณู ูุดุงูุฏุงุช ุงูุจุซ ุงููุจุงุดุฑ", callback_data="show_live_views")],
        [InlineKeyboardButton("ูุณู ุดุญู ุดุฏุงุช ุจุจุฌู", callback_data="show_pubg")],
        [InlineKeyboardButton("ุฑูุน ุณููุฑ ุชููุชูู", callback_data="show_tiktok_score")],
        [InlineKeyboardButton("ูุณู ุดุฑุงุก ุฑุตูุฏ ุงูุชููุฒ", callback_data="show_itunes_services")],
        [InlineKeyboardButton("ุฎุฏูุงุช ุงูุชููุฌุฑุงู", callback_data="show_telegram_services")],
        [InlineKeyboardButton("ุฑุฌูุน", callback_data="back_main")],
    ]
    return InlineKeyboardMarkup(buttons)

def tiktok_score_keyboard():
    """ููุญุฉ ุฎุฏูุงุช ุฑูุน ุณููุฑ ุชููุชูู."""
    score_services = {k: v for k, v in services_dict.items() if "ุฑูุน ุณููุฑ" in k}
    service_buttons = []
    for service_name, price in score_services.items():
        btn_text = f"{service_name} - {price}$"
        service_buttons.append(
            [InlineKeyboardButton(btn_text, callback_data=f"service_{service_name}")]
        )
    service_buttons.append(
        [InlineKeyboardButton("ุฑุฌูุน", callback_data="show_services")]
    )
    return InlineKeyboardMarkup(service_buttons)

def itunes_services_keyboard():
    """ููุญุฉ ุฎุฏูุงุช ุดุฑุงุก ุฑุตูุฏ ุงูุชููุฒ."""
    buttons = []
    for service_name, price in itunes_services.items():
        btn_text = f"{service_name} - {price}$"
        buttons.append(
            [InlineKeyboardButton(btn_text, callback_data=f"itunes_service_{service_name}")]
        )
    buttons.append([InlineKeyboardButton("ุฑุฌูุน", callback_data="show_services")])
    return InlineKeyboardMarkup(buttons)

def telegram_services_keyboard():
    """ููุญุฉ ุฎุฏูุงุช ุงูุชูุบุฑุงู."""
    buttons = []
    for service_name, price in telegram_services.items():
        btn_text = f"{service_name} - {price}$"
        buttons.append(
            [InlineKeyboardButton(btn_text, callback_data=f"telegram_service_{service_name}")]
        )
    buttons.append([InlineKeyboardButton("ุฑุฌูุน", callback_data="show_services")])
    return InlineKeyboardMarkup(buttons)

###############################################################################
# ุฏูุงู ูุณุงุนุฏุฉ
###############################################################################
def clear_all_waiting_flags(context: CallbackContext):
    """
    ูุณุญ ุฌููุน ุงูุนูุงูุงุช (Flags) ุงูุชู ุชุฏู ุนูู ุงูุชุธุงุฑ ุฅุฏุฎุงู ูู ุงููุณุชุฎุฏูุ
    ูููุน ุชุฏุงุฎู ุงููุฏุฎูุงุช ูู ุฃูุงูุฑ ูุชุนุฏุฏุฉ.
    """
    waiting_keys = [
        "waiting_for_card",
        "waiting_for_block",
        "waiting_for_add_balance_user_id",
        "waiting_for_add_balance_amount",
        "waiting_for_discount_user_id",
        "waiting_for_discount_amount",
        "waiting_for_broadcast",
        "waiting_for_api_order_status",
        "selected_service",
        "service_price",
        "selected_pubg_service",
        "pubg_service_price",
        "card_to_approve",
        "card_to_approve_index",
        "waiting_for_amount",
        "selected_itunes_service",
        "itunes_service_price",
        "waiting_for_itunes_confirm",
        "itunes_temp_choice",
        "waiting_for_itunes_code",
        "itunes_to_complete",
        "itunes_to_complete_index",
        "selected_telegram_service",
        "telegram_service_price",
        "waiting_for_telegram_link"
    ]
    for key in waiting_keys:
        context.user_data.pop(key, None)

def broadcast_ad(update: Update, context: CallbackContext):
    """
    ุฅุฑุณุงู ุฅุนูุงู (ุตูุฑุฉุ ููุฏููุ ุฑุณุงูุฉ ูุตูุฉุ ุฃู ุชุณุฌูู ุตูุชู) ูุฌููุน ุงููุณุชุฎุฏููู.
    """
    announcement_prefix = "โจ ุฅุนูุงู ูู ูุงูู ุงูุจูุช โจ\n\n"
    all_users = get_all_users()
    admin_reply = "ุชู ุฅุฑุณุงู ุงูุฅุนูุงู ูุฌููุน ุงููุณุชุฎุฏููู."
    msg = update.message

    if msg.photo:
        file_id = msg.photo[-1].file_id
        caption = msg.caption if msg.caption else ""
        new_caption = announcement_prefix + caption

        for usr in all_users:
            try:
                context.bot.send_photo(chat_id=usr[0], photo=file_id, caption=new_caption)
            except Exception as e:
                logger.error("Error sending photo to %s: %s", usr[0], e)
        msg.reply_text(admin_reply)

    elif msg.video:
        file_id = msg.video.file_id
        caption = msg.caption if msg.caption else ""
        new_caption = announcement_prefix + caption

        for usr in all_users:
            try:
                context.bot.send_video(chat_id=usr[0], video=file_id, caption=new_caption)
            except Exception as e:
                logger.error("Error sending video to %s: %s", usr[0], e)
        msg.reply_text(admin_reply)

    elif msg.voice:
        file_id = msg.voice.file_id
        for usr in all_users:
            try:
                context.bot.send_message(chat_id=usr[0], text=announcement_prefix)
                context.bot.send_voice(chat_id=usr[0], voice=file_id)
            except Exception as e:
                logger.error("Error sending voice to %s: %s", usr[0], e)
        msg.reply_text(admin_reply)

    elif msg.text:
        text_to_send = announcement_prefix + msg.text
        for usr in all_users:
            try:
                context.bot.send_message(chat_id=usr[0], text=text_to_send)
            except Exception as e:
                logger.error("Error sending text to %s: %s", usr[0], e)
        msg.reply_text(admin_reply)

    else:
        msg.reply_text("ููุน ุงูุฑุณุงูุฉ ุบูุฑ ูุฏุนูู.")

def api_check_balance(update: Update, context: CallbackContext):
    """ูุญุต ุฑุตูุฏ ุงูู API."""
    params = {'key': API_KEY, 'action': 'balance'}
    text_msg = ""

    try:
        response = requests.post(API_URL, data=params)
        balance_info = response.json()
        if "balance" in balance_info:
            text_msg = f"ุฑุตูุฏ ุญุณุงุจู ูู API: {balance_info['balance']}$"
        else:
            text_msg = f"ุญุฏุซ ุฎุทุฃ ูู ุฌูุจ ุงูุฑุตูุฏ ูู API: {balance_info.get('error', 'ุบูุฑ ูุนุฑูู')}"
    except Exception:
        text_msg = "ูุดู ุงูุงุชุตุงู ุจุงูู API."

    if update.callback_query:
        query = update.callback_query
        btns = [[InlineKeyboardButton("ุฑุฌูุน", callback_data="admin_menu")]]
        query.edit_message_text(text_msg, reply_markup=InlineKeyboardMarkup(btns))
    else:
        update.message.reply_text(text_msg)

def start(update: Update, context: CallbackContext):
    """
    ุฃูุฑ /start ูุชุณุฌูู ุงููุณุชุฎุฏู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฅู ูู ููู ููุฌูุฏูุง
    ูุฅุธูุงุฑ ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ.
    """
    user_id = update.effective_user.id
    # ูุญุต ุงูุญุธุฑ
    if user_id in blocked_users and user_id != ADMIN_ID:
        update.message.reply_text("ููุฏ ุชู ุญุถุฑู ูู ุงุณุชุฎุฏุงู ุงูุจูุช ๐คฃ.\nุงูุชุธุฑ ุญุชู ูุชู ุงูุบุงุก ุญุธุฑู.")
        return

    full_name = update.effective_user.full_name
    username = update.effective_user.username or "NoUsername"

    # ุฅุถุงูุฉ ุงููุณุชุฎุฏู ููุงุนุฏุฉ ุงูุจูุงูุงุช ูุชุญุฏูุซ ุงุณูู
    add_user_to_db(user_id, full_name, username)
    update_username_in_db(user_id, username)
    sync_balance_from_db(user_id)

    text_msg = "ูุฑุญุจุงู ุจู ูู ุงูุจูุช!"
    reply_markup = main_menu_keyboard(user_id)
    update.message.reply_text(text_msg, reply_markup=reply_markup)

def approve_order_process(order_index: int, context: CallbackContext, query):
    """
    ูุนุงูุฌุฉ ุงูููุงููุฉ ุนูู ุทูุจ ุฎุฏูุฉ (pending_orders) ุนุจุฑ ุงุณุชุฏุนุงุก ุงูู API ุฅู ูุฌุฏุ
    ุฃู ููุท ุฅุถุงูุชู ููุงุฆูุฉ completed_orders ุฅุฐุง ูู ุชูุฌุฏ ูู ุฎุฑูุทุฉ ูู service_api_mapping.
    """
    order_info = pending_orders.pop(order_index)
    if order_info['service'] in service_api_mapping:
        # ูุญุงููุฉ ุงูุชูููุฐ ุนุจุฑ ุงูู API
        mapping = service_api_mapping[order_info['service']]
        quantity = mapping['quantity_multiplier']

        params = {
            'key': API_KEY,
            'action': 'add',
            'service': mapping['service_id'],
            'link': order_info['link'],
            'quantity': quantity
        }
        try:
            response = requests.post(API_URL, data=params)
            api_response = response.json()
        except Exception:
            api_response = {"error": "ูุดู ุงุณุชุฏุนุงุก API"}

        if "order" in api_response:
            # ุชู ูุจูู ุงูุทูุจ ูู ุงูู API
            order_info["order_number"] = api_response["order"]
            order_info["service_number"] = mapping["service_id"]
            order_info["refunded"] = False
            order_info["completed_at"] = time.time()

            completed_orders.append(order_info)

            context.bot.send_message(
                chat_id=order_info['user_id'],
                text=f"ุชู ุงุณุชูุงู ุทูุจู ูุณูู ูุชู ุชูููุฐู ูุฑูุจุงู\nุฑูู ุทูุจู ({api_response['order']})"
            )
            btns = [[InlineKeyboardButton("ุฑุฌูุน", callback_data="review_orders")]]
            query.edit_message_text(
                "ุชู ุชูููุฐ ุงูุทูุจ ุนุจุฑ API ูุฅุดุนุงุฑ ุงููุณุชุฎุฏู.",
                reply_markup=InlineKeyboardMarkup(btns)
            )
        else:
            # ูุดู ุชูููุฐ ุงูุทูุจ ุนุจุฑ ุงูู API -> ุงุณุชุนุงุฏุฉ ุงูุฑุตูุฏ ูููุณุชุฎุฏู
            users_balance[order_info['user_id']] += order_info['price']
            sync_balance_to_db(order_info['user_id'])

            context.bot.send_message(
                chat_id=order_info['user_id'],
                text="ูุดู ุชูููุฐ ุงูุทูุจ ุนุจุฑ ุงููุธุงู ุงูุฎุงุฑุฌูุ ุชูุช ุฅุนุงุฏุฉ ุงููุจูุบ ูุฑุตูุฏู."
            )
            btns = [[InlineKeyboardButton("ุฑุฌูุน", callback_data="review_orders")]]
            query.edit_message_text(
                "ูุดู ุชูููุฐ ุงูุทูุจ ุนุจุฑ API ูุชูุช ุฅุนุงุฏุฉ ุงูุฑุตูุฏ ูููุณุชุฎุฏู.",
                reply_markup=InlineKeyboardMarkup(btns)
            )
    else:
        # ูุง ููุฌุฏ ุฑูู ุฎุฏูุฉ ูู ุงููุงููุณ -> ุฎุฏูุฉ ูุฏููุฉ
        order_info["order_number"] = "N/A"
        order_info["service_number"] = "N/A"
        order_info["refunded"] = False
        order_info["completed_at"] = time.time()
        completed_orders.append(order_info)

        context.bot.send_message(
            chat_id=order_info['user_id'],
            text="ุชู ุฅููุงู ุทูุจู ุจูุฌุงุญ (ุฏูู ุชูููุฐ API)ุ ูุง ููุฌุฏ ุชุทุงุจู ููุฎุฏูุฉ."
        )
        btns = [[InlineKeyboardButton("ุฑุฌูุน", callback_data="review_orders")]]
        query.edit_message_text("ุชู ุชุฃููุฏ ุงูุทูุจ ูุฅุดุนุงุฑ ุงููุณุชุฎุฏู.", reply_markup=InlineKeyboardMarkup(btns))

###############################################################################
# ุงูุฏุงูุฉ ุงููุณุคููุฉ ุนู ุงูุชุนุงูู ูุน CallbackQuery
###############################################################################
def button_handler(update: Update, context: CallbackContext):
    """ุงูุฏุงูุฉ ุงููุณุคููุฉ ุนู ูู ุงูุฃุฒุฑุงุฑ ุงูุชูุงุนููุฉ ูู ุงูุฑุณุงุฆู."""
    query = update.callback_query
    user_id = query.from_user.id
    data = query.data
    query.answer()  # ุฑุฏ ุณุฑูุน ูุญุฐู ุฑูุฒ ุงูุชุญููู

    # ุชูุธูู ุฃู ุนูุงูุงุช ุงูุชุธุงุฑ ูุฏููุฉ
    clear_all_waiting_flags(context)

    # ููุน ุงููุณุชุฎุฏููู ุงููุญุธูุฑูู (ุจุงุณุชุซูุงุก ADMIN)
    if user_id in blocked_users and user_id != ADMIN_ID:
        query.answer("ููุฏ ุชู ุญุถุฑู ูู ุงุณุชุฎุฏุงู ุงูุจูุช ๐คฃ.", show_alert=True)
        return

    ####################################
    # ุฃูุงูุฑ ุนุงูุฉ ูููุณุชุฎุฏููู
    ####################################
    if data.startswith("service_"):
        # ุชู ุงุฎุชูุงุฑ ุฎุฏูุฉ ูู ุฎุฏูุงุช ุงูุฑุดู
        service_name = data[len("service_"):]
        price = services_dict.get(service_name)
        if price is None:
            query.edit_message_text("ุงูุฎุฏูุฉ ุบูุฑ ููุฌูุฏุฉ.")
            return

        current_balance = users_balance.get(user_id, 0.0)
        if current_balance < price:
            buttons = [
                [InlineKeyboardButton("ุดุญู ุนุจุฑ ุงุณูุงุณูู", callback_data="charge_asiacell")],
                [InlineKeyboardButton("ุฑุฌูุน", callback_data="show_services")]
            ]
            query.edit_message_text("ุฑุตูุฏู ููุณ ูุงููุงู.", reply_markup=InlineKeyboardMarkup(buttons))
            return

        # ุชุญุถูุฑ ุฑุณุงูุฉ ุงููุทุงูุจุฉ ุจุงูุฑุงุจุท ุงูููุงุณุจ
        if "ุงูุณุชุบุฑุงู" in service_name:
            message_text = (
                "ุงูุฑุฌุงุก ุฅุฑุณุงู ุฑุงุจุท ุงูุฎุฏูุฉ ุงูุฎุงุต ุจู\n"
                "๐ด ุชูุจูู:\n"
                "ูุฑุฌู ุฅุทูุงุก ุฒุฑ 'ุชููุฒ ูููุฑุงุฌุนุฉ' ุฏุงุฎู ุญุณุงุจู ุงูุงูุณุชุบุฑุงู ูุจู ุงุฑุณุงู ุฑุงุจุท ุงูุฎุฏูุฉ ูุถูุงู ุฅููุงู ุทูุจู!"
            )
        elif "ุฑูุน ุณููุฑ ุจุซ" in service_name:
            message_text = (
                "ูุฑุฌู ุงุฑุณุงู ุฑุงุจุท ุงูุจุซ ุงูุฎุงุต ุจู\n"
                "๐ดุชูุจูู: ูุฑุฌู ุงุฑุณุงู ุฑุงุจุท ุงูุจุซ ูููุณ ุงูููุฒุฑููู!!"
            )
        elif "ุชููุชูู" in service_name:
            message_text = (
                "ุงูุฑุฌุงุก ุฅุฑุณุงู ุงูุฑุงุจุท ุงูุฎุงุต ุจุงูุฎุฏูุฉ ุงููุทููุจุฉ:\n"
                "๐ดููุงุญุธุฉ: ุงุฑุณู ุงูุฑุงุจุท ูููุณ ุงูููุฒุฑููู!"
            )
        else:
            message_text = "ุงูุฑุฌุงุก ุฅุฑุณุงู ุงูุฑุงุจุท ุงูุฎุงุต ุจุงูุฎุฏูุฉ ุงููุทููุจุฉ:"

        context.user_data["selected_service"] = service_name
        context.user_data["service_price"] = price
        query.edit_message_text(message_text)
        return

    if data == "back_main":
        # ุงูุฑุฌูุน ุฅูู ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ
        query.edit_message_text("ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ:", reply_markup=main_menu_keyboard(user_id))
        return

    if data == "show_services":
        query.edit_message_text("ุงุฎุชุฑ ุงููุณู:", reply_markup=services_menu_keyboard())
        return

    if data == "show_tiktok_score":
        query.edit_message_text(
            "ุงุฎุชุฑ ุฎุฏูุฉ ุฑูุน ุณููุฑ ุชููุชูู ุงููุทููุจุฉ:",
            reply_markup=tiktok_score_keyboard()
        )
        return

    ####################################
    # ุฃูุงูุฑ ููุญุฉ ุชุญูู ุงููุงูู
    ####################################
    if data == "admin_menu":
        if user_id == ADMIN_ID:
            query.edit_message_text("ููุญุฉ ุชุญูู ุงููุงูู:", reply_markup=admin_menu_keyboard())
        else:
            query.edit_message_text("ุนุฐุฑุงูุ ุฃูุช ูุณุช ุงููุงูู.")
        return

    if user_id == ADMIN_ID:
        if data == "block_user":
            query.edit_message_text("ุฃุฑุณู ุงูููุฒุฑููู ุฃู ุงูุขูุฏู ูููุณุชุฎุฏู ุงูุฐู ุชุฑูุฏ ุญุถุฑู:")
            context.user_data["waiting_for_block"] = True
            return

        if data == "unblock_user":
            if not blocked_users:
                query.edit_message_text("ูุง ููุฌุฏ ูุณุชุฎุฏููู ูุญุธูุฑูู ุญุงููุงู.")
            else:
                text_msg = "ูุงุฆูุฉ ุงููุณุชุฎุฏููู ุงููุญุธูุฑูู:\n"
                keyboard = []

                for uid in blocked_users:
                    row = get_user_from_db(uid)
                    user_display = f"{row[1]} (@{row[2]})" if row else f"User {uid}"
                    text_msg += f"{user_display} (ID: {uid})\n"
                    keyboard.append(
                        [InlineKeyboardButton(f"ุฅูุบุงุก ุญุธุฑ {user_display}", callback_data=f"unblock_{uid}")]
                    )

                reply_markup = InlineKeyboardMarkup(keyboard)
                query.edit_message_text(text_msg, reply_markup=reply_markup)
            return

        if data.startswith("unblock_"):
            try:
                target_id = int(data.split("_")[1])
            except Exception:
                query.edit_message_text("ุญุฏุซ ุฎุทุฃ ูู ุจูุงูุงุช ุงููุณุชุฎุฏู.")
                return

            if target_id in blocked_users:
                del blocked_users[target_id]
                query.edit_message_text("ุชู ุฅูุบุงุก ุญุธุฑ ุงููุณุชุฎุฏู ุจูุฌุงุญ.")
            else:
                query.edit_message_text("ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ ูู ุงููุงุฆูุฉ ุงููุญุธูุฑุฉ.")
            return

        if data == "admin_add_balance":
            query.edit_message_text("ุฃุฑุณู ุงูุขู ุขูุฏู ุงููุณุชุฎุฏู ุงูุฐู ุชุฑูุฏ ุฅุถุงูุฉ ุงูุฑุตูุฏ ูู:")
            context.user_data["waiting_for_add_balance_user_id"] = True
            return

        if data == "admin_discount":
            query.edit_message_text("ุฃุฑุณู ุงูุขู ุขูุฏู ุงููุณุชุฎุฏู ุงูุฐู ุชุฑูุฏ ุฎุตู ุงูุฑุตูุฏ ููู:")
            context.user_data["waiting_for_discount_user_id"] = True
            return

        if data == "admin_announce":
            query.edit_message_text(
                "ุฃุฑุณู ุงูุขู ุงูุฑุณุงูุฉ ุฃู ุงููุณุงุฆุท (ุตูุฑุฉ/ููุฏูู/ุชุณุฌูู ุตูุชู/ูุต) ูุฅุนูุงู ุงูุจูุช ูุฌููุน ุงููุณุชุฎุฏููู:"
            )
            context.user_data["waiting_for_broadcast"] = True
            return

        if data == "admin_users_count":
            users = get_all_users()
            count_users = len(users)
            text_msg = f"ุนุฏุฏ ุงููุณุชุฎุฏููู: {count_users}\n\n"

            for i, usr in enumerate(users, start=1):
                text_msg += f"{i}) ุงูุงุณู: {usr[1]}, ููุฒุฑ: @{usr[2]}, ุฃูุฏู: {usr[0]}\n"

            btns = [[InlineKeyboardButton("ุฑุฌูุน", callback_data="admin_menu")]]
            query.edit_message_text(text_msg, reply_markup=InlineKeyboardMarkup(btns))
            return

        if data == "admin_users_balance":
            users = get_users_with_balance_desc()
            if not users:
                text_msg = "ูุง ููุฌุฏ ูุณุชุฎุฏููู ูุฏููู ุฑุตูุฏ > 0."
            else:
                text_msg = "ูุณุชุฎุฏูู ุงูุจูุช (ุฑุตูุฏ > 0) - ุชุฑุชูุจ ุชูุงุฒูู:\n\n"
                for i, usr in enumerate(users, start=1):
                    text_msg += (
                        f"{i}) ุงูุงุณู: {usr[1]}, ููุฒุฑ: @{usr[2]}, ุงูุฑุตูุฏ: {usr[3]}$, ุฃูุฏู: {usr[0]}\n"
                    )
            btns = [[InlineKeyboardButton("ุฑุฌูุน", callback_data="admin_menu")]]
            query.edit_message_text(text_msg, reply_markup=InlineKeyboardMarkup(btns))
            return

        if data == "review_orders":
            # ุนุฑุถ ุงูุทูุจุงุช ุงูููุชููุฉ (ูููุฐุฉ ุนุจุฑ API)
            filtered = []
            for i, order in enumerate(completed_orders):
                if order.get("order_number", "N/A") != "N/A":
                    filtered.append((i, order))

            if not filtered:
                btns = [[InlineKeyboardButton("ุฑุฌูุน", callback_data="admin_menu")]]
                query.edit_message_text("ูุง ุชูุฌุฏ ุทูุจุงุช ุชู ุชูููุฐูุง ุนุจุฑ API.", reply_markup=InlineKeyboardMarkup(btns))
                return

            keyboard = []
            text_msg = ""

            for display_idx, (orig_idx, order) in enumerate(filtered, start=1):
                text_msg += (
                    f"{display_idx}) ุงูุงุณู: {order['full_name']}, ุงูุฎุฏูุฉ: {order['service']}, "
                    f"ุงูุณุนุฑ: {order['price']}$, ุฑูู ุงูุทูุจ: {order.get('order_number', 'N/A')}\n\n"
                )
                keyboard.append(
                    [InlineKeyboardButton("ุงุดุนุงุฑ ุงููุณุชุฎุฏู", callback_data=f"notify_order_{orig_idx}")]
                )
                keyboard.append(
                    [InlineKeyboardButton("ุงุฑุฌุงุน ุงูุฑุตูุฏ", callback_data=f"refund_order_{orig_idx}")]
                )

            keyboard.append([InlineKeyboardButton("ุฑุฌูุน", callback_data="admin_menu")])
            query.edit_message_text(text_msg, reply_markup=InlineKeyboardMarkup(keyboard))
            return

        if data.startswith("notify_order_"):
            try:
                order_index = int(data.split("_")[-1])
            except ValueError:
                query.answer("ุฎุทุฃ ูู ุจูุงูุงุช ุงูุทูุจ", show_alert=True)
                return

            if order_index < 0 or order_index >= len(completed_orders):
                query.answer("ุทูุจ ุบูุฑ ููุฌูุฏ", show_alert=True)
                return

            order = completed_orders[order_index]
            context.bot.send_message(chat_id=order['user_id'], text="ุชู ุชูููุฐ ุทูุจู ุจูุฌุงุญ")
            query.answer("ุชู ุฅุฑุณุงู ุฅุดุนุงุฑ ูููุณุชุฎุฏู", show_alert=True)
            return

        if data.startswith("refund_order_"):
            try:
                order_index = int(data.split("_")[-1])
                order = completed_orders[order_index]
            except (IndexError, ValueError):
                query.edit_message_text("ุทูุจ ุบูุฑ ููุฌูุฏ.")
                return

            if order.get("refunded", False):
                query.answer("ููุฏ ุชู ุงุฑุฌุงุน ุงูุฑุตูุฏ ูุณุจูุงู.", show_alert=True)
                return

            refund_amount = order['price']
            target_id = order['user_id']
            users_balance[target_id] = users_balance.get(target_id, 0.0) + refund_amount
            sync_balance_to_db(target_id)
            order["refunded"] = True

            context.bot.send_message(
                chat_id=target_id,
                text=f"ุชู ุงุณุชุนุงุฏุฉ ุฑุตูุฏู ุงููุฎุตูู ({refund_amount}$)"
            )
            query.answer("ุชู ุงุฑุฌุงุน ุงูุฑุตูุฏ.")

            # ุฅุนุงุฏุฉ ุนุฑุถ ูุงุฆูุฉ ุงูุทูุจุงุช
            filtered = []
            for i, o in enumerate(completed_orders):
                if o.get("order_number", "N/A") != "N/A":
                    filtered.append((i, o))

            if not filtered:
                btns = [[InlineKeyboardButton("ุฑุฌูุน", callback_data="admin_menu")]]
                query.edit_message_text("ูุง ุชูุฌุฏ ุทูุจุงุช ุชู ุชูููุฐูุง ุนุจุฑ API.", reply_markup=InlineKeyboardMarkup(btns))
                return

            keyboard = []
            text_msg = ""

            for display_idx, (orig_idx, ord_data) in enumerate(filtered, start=1):
                text_msg += (
                    f"{display_idx}) ุงูุงุณู: {ord_data['full_name']}, ุงูุฎุฏูุฉ: {ord_data['service']}, "
                    f"ุงูุณุนุฑ: {ord_data['price']}$, ุฑูู ุงูุทูุจ: {ord_data.get('order_number', 'N/A')}\n\n"
                )
                keyboard.append(
                    [InlineKeyboardButton("ุงุดุนุงุฑ ุงููุณุชุฎุฏู", callback_data=f"notify_order_{orig_idx}")]
                )
                keyboard.append(
                    [InlineKeyboardButton("ุงุฑุฌุงุน ุงูุฑุตูุฏ", callback_data=f"refund_order_{orig_idx}")]
                )

            keyboard.append([InlineKeyboardButton("ุฑุฌูุน", callback_data="admin_menu")])
            query.edit_message_text(text_msg, reply_markup=InlineKeyboardMarkup(keyboard))
            return

        if data == "pending_cards":
            if not pending_cards:
                btns = [[InlineKeyboardButton("ุฑุฌูุน", callback_data="admin_menu")]]
                query.edit_message_text("ูุง ุชูุฌุฏ ูุฑูุช ูุนููุฉ ุญุงููุงู.", reply_markup=InlineKeyboardMarkup(btns))
            else:
                text_msg = "ุงููุฑูุช ุงููุนููุฉ:\n"
                buttons = []
                for idx, card in enumerate(pending_cards):
                    text_msg += f"{idx+1}) @{card['username']} - ูุงุฑุช ูุนูู\n"
                    buttons.append(
                        [InlineKeyboardButton(f"ูุนุงูุฌุฉ ุงููุงุฑุช {idx+1}", callback_data=f"process_card_{idx}")]
                    )

                buttons.append([InlineKeyboardButton("ุฑุฌูุน", callback_data="admin_menu")])
                query.edit_message_text(text_msg, reply_markup=InlineKeyboardMarkup(buttons))
            return

        if data.startswith("process_card_"):
            card_index = int(data.split("_")[-1])
            card_info = pending_cards[card_index]
            text_msg = (
                f"ุชูุงุตูู ุงููุงุฑุช ุฑูู {card_index+1}:\n"
                f"- ุงููุนุฑู: {card_info['user_id']}\n"
                f"- ุงูุงุณู: {card_info['full_name']}\n"
                f"- ููุฒุฑ: @{card_info['username']}\n"
                f"- ุฑูู ุงููุงุฑุช: ุงุถุบุท ุฒุฑ (ุฅุธูุงุฑ ุงูุฑูู) ุฃุฏูุงู.\n\n"
                "ุงุฎุชุฑ ุงูุฅุฌุฑุงุก:"
            )
            btns = [
                [InlineKeyboardButton("ุฅุธูุงุฑ ุงูุฑูู", callback_data=f"show_card_{card_index}")],
                [
                    InlineKeyboardButton("ูุจูู ุงููุงุฑุช", callback_data=f"approve_card_{card_index}"),
                    InlineKeyboardButton("ุฑูุถ ุงููุงุฑุช", callback_data=f"reject_card_{card_index}")
                ],
                [InlineKeyboardButton("ุฑุฌูุน", callback_data="pending_cards")]
            ]
            query.edit_message_text(text_msg, reply_markup=InlineKeyboardMarkup(btns))
            return

        if data.startswith("show_card_"):
            card_index = int(data.split("_")[-1])
            card_info = pending_cards[card_index]
            query.message.reply_text(
                text=f"ุฑูู ุงููุงุฑุช:\n`{card_info['card_number']}`\n(ุงุถุบุท ูุทููุงู ูููุณุฎ)",
                parse_mode="Markdown"
            )
            query.answer()
            return

        if data.startswith("approve_card_"):
            card_index = int(data.split("_")[-1])
            card_info = pending_cards[card_index]
            btns = [[InlineKeyboardButton("ุฑุฌูุน", callback_data="pending_cards")]]
            query.edit_message_text(
                "ุฃุฑุณู ุงูุขู ุงููุจูุบ ุงููุฑุงุฏ ุดุญูู ูููุณุชุฎุฏู:",
                reply_markup=InlineKeyboardMarkup(btns)
            )
            context.user_data["card_to_approve"] = card_info
            context.user_data["card_to_approve_index"] = card_index
            context.user_data["waiting_for_amount"] = True
            return

        if data.startswith("reject_card_"):
            card_index = int(data.split("_")[-1])
            card_info = pending_cards.pop(card_index)
            context.bot.send_message(
                chat_id=card_info["user_id"],
                text="ุชู ุฑูุถ ุงูุดุญู ูุฃู ุฑูู ุงููุงุฑุช ุบูุฑ ุตุญูุญ."
            )
            btns = [[InlineKeyboardButton("ุฑุฌูุน", callback_data="pending_cards")]]
            query.edit_message_text("ุชู ุฑูุถ ุงููุงุฑุช ุจูุฌุงุญ.", reply_markup=InlineKeyboardMarkup(btns))
            return

        if data == "pending_pubg_orders":
            if not pending_pubg_orders:
                btns = [[InlineKeyboardButton("ุฑุฌูุน", callback_data="admin_menu")]]
                query.edit_message_text("ูุง ุชูุฌุฏ ุทูุจุงุช ุดุฏุงุช ุจุจุฌู ูุนููุฉ ุญุงููุงู.", reply_markup=InlineKeyboardMarkup(btns))
            else:
                text_msg = "ุทูุจุงุช ุดุฏุงุช ุจุจุฌู ุงููุนููุฉ:\n"
                buttons = []
                for idx, order in enumerate(pending_pubg_orders):
                    text_msg += (
                        f"{idx+1}) ุทูุจ ูู @{order['username']} - ุงูุฎุฏูุฉ: {order['service']}, "
                        f"ุงูุขูุฏู: {order['pubg_id']}\n"
                    )
                    buttons.append(
                        [InlineKeyboardButton(f"ูุนุงูุฌุฉ ุงูุทูุจ ุฑูู {idx+1}", callback_data=f"process_pubg_order_{idx}")]
                    )

                buttons.append([InlineKeyboardButton("ุฑุฌูุน", callback_data="admin_menu")])
                query.edit_message_text(text_msg, reply_markup=InlineKeyboardMarkup(buttons))
            return

        if data.startswith("process_pubg_order_"):
            order_index = int(data.split("_")[-1])
            order_info = pending_pubg_orders[order_index]
            text_msg = (
                f"ุชูุงุตูู ุทูุจ ุดุญู ุดุฏุงุช ุจุจุฌู ุฑูู {order_index+1}:\n"
                f"- ุงููุนุฑู: {order_info['user_id']}\n"
                f"- ุงูุงุณู: {order_info['full_name']}\n"
                f"- ููุฒุฑ: @{order_info['username']}\n"
                f"- ุงูุฎุฏูุฉ: {order_info['service']}\n"
                f"- ุงูุณุนุฑ: {order_info['price']}$\n"
                f"- ุงูุขูุฏู: {order_info['pubg_id']}\n\n"
                "ุงุฎุชุฑ ุงูุฅุฌุฑุงุก:"
            )
            btns = [
                [
                    InlineKeyboardButton("ุชู ุดุญู ุงูุดุฏุงุช", callback_data=f"approve_pubg_order_{order_index}"),
                    InlineKeyboardButton("ุชู ุงูุบุงุก ุงูุดุฏุงุช", callback_data=f"reject_pubg_order_{order_index}")
                ],
                [InlineKeyboardButton("ุงูุชุธุงุฑ ุงููุณุชุฎุฏู", callback_data=f"user_wait_pubg_order_{order_index}")],
                [InlineKeyboardButton("ุฑุฌูุน", callback_data="pending_pubg_orders")]
            ]
            query.edit_message_text(text_msg, reply_markup=InlineKeyboardMarkup(btns))
            return

        if data.startswith("approve_pubg_order_"):
            order_index = int(data.split("_")[-1])
            order_info = pending_pubg_orders.pop(order_index)
            context.bot.send_message(chat_id=order_info['user_id'], text="ุชู ุดุญู ุดุฏุงุช ุจุจุฌู ุจูุฌุงุญ.")
            btns = [[InlineKeyboardButton("ุฑุฌูุน", callback_data="pending_pubg_orders")]]
            query.edit_message_text("ุชู ุดุญู ุดุฏุงุช ุจุจุฌู ูุฅุดุนุงุฑ ุงููุณุชุฎุฏู.", reply_markup=InlineKeyboardMarkup(btns))
            return

        if data.startswith("reject_pubg_order_"):
            order_index = int(data.split("_")[-1])
            order_info = pending_pubg_orders.pop(order_index)
            users_balance[order_info['user_id']] += order_info['price']
            sync_balance_to_db(order_info['user_id'])
            context.bot.send_message(
                chat_id=order_info['user_id'],
                text="ุชู ุฅูุบุงุก ุทูุจ ุดุญู ุดุฏุงุช ุจุจุฌู ูุฅุนุงุฏุฉ ุงููุจูุบ ุฅูู ุญุณุงุจู."
            )
            btns = [[InlineKeyboardButton("ุฑุฌูุน", callback_data="pending_pubg_orders")]]
            query.edit_message_text("ุชู ุฅูุบุงุก ุทูุจ ุดุญู ุดุฏุงุช ุจุจุฌู ูุฅุนุงุฏุฉ ุงููุจูุบ ูููุณุชุฎุฏู.", reply_markup=InlineKeyboardMarkup(btns))
            return

        if data.startswith("user_wait_pubg_order_"):
            order_index = int(data.split("_")[-1])
            order_info = pending_pubg_orders[order_index]
            context.bot.send_message(
                chat_id=order_info['user_id'],
                text="ุณูู ูุชู ุชูููุฐ ุทูุจู ูุฑูุจุง"
            )
            btns = [[InlineKeyboardButton("ุฑุฌูุน", callback_data="pending_pubg_orders")]]
            query.edit_message_text("ุชู ุฅุฑุณุงู ุฅุดุนุงุฑ ุงูุงูุชุธุงุฑ ูููุณุชุฎุฏู.", reply_markup=InlineKeyboardMarkup(btns))
            return

        if data == "api_check_balance":
            api_check_balance(update, context)
            return

        if data == "api_order_status":
            query.edit_message_text("ุฃุฏุฎู ุฑูู ุงูุทูุจ ููุชุญูู ูู ุญุงูุชู ุนุจุฑ API:")
            context.user_data["waiting_for_api_order_status"] = True
            return

        if data == "pending_itunes_orders":
            if not pending_itunes_orders:
                btns = [[InlineKeyboardButton("ุฑุฌูุน", callback_data="admin_menu")]]
                query.edit_message_text("ูุง ุชูุฌุฏ ุทูุจุงุช ุดุญู ุงูุชููุฒ ูุนููุฉ ุญุงููุงู.", reply_markup=InlineKeyboardMarkup(btns))
            else:
                text_msg = "ุทูุจุงุช ุดุญู ุงูุงูุชููุฒ ุงููุนููุฉ:\n"
                buttons = []
                for idx, order in enumerate(pending_itunes_orders):
                    text_msg += (
                        f"{idx+1}) @{order['username']} - {order['service']} ุจุณุนุฑ {order['price']}$\n"
                    )
                    buttons.append(
                        [InlineKeyboardButton(
                            f"ูุนุงูุฌุฉ ุงูุทูุจ ุฑูู {idx+1}",
                            callback_data=f"process_itunes_{idx}"
                        )]
                    )
                buttons.append([InlineKeyboardButton("ุฑุฌูุน", callback_data="admin_menu")])
                query.edit_message_text(text_msg, reply_markup=InlineKeyboardMarkup(buttons))
            return

        if data.startswith("process_itunes_"):
            itunes_index = int(data.split("_")[-1])
            itunes_order = pending_itunes_orders[itunes_index]
            text_msg = (
                f"ุชูุงุตูู ุทูุจ ุดุญู ุงูุชููุฒ ุฑูู {itunes_index+1}:\n"
                f"- ุงููุนุฑู: {itunes_order['user_id']}\n"
                f"- ุงูุงุณู: {itunes_order['full_name']}\n"
                f"- ููุฒุฑ: @{itunes_order['username']}\n"
                f"- ุงูุฎุฏูุฉ: {itunes_order['service']}\n"
                f"- ุงูุณุนุฑ: {itunes_order['price']}$\n\n"
                "ุงุฎุชุฑ ุงูุฅุฌุฑุงุก:"
            )
            btns = [
                [InlineKeyboardButton("ุงูุชุธุงุฑ ุงููุณุชุฎุฏู", callback_data=f"itunes_wait_{itunes_index}")],
                [InlineKeyboardButton("ุงููุงู ุงูุทูุจ", callback_data=f"itunes_complete_{itunes_index}")],
                [InlineKeyboardButton("ุงูุบุงุก ุงูุทูุจ", callback_data=f"itunes_cancel_{itunes_index}")],
                [InlineKeyboardButton("ุฑุฌูุน", callback_data="pending_itunes_orders")]
            ]
            query.edit_message_text(text_msg, reply_markup=InlineKeyboardMarkup(btns))
            return

        if data.startswith("itunes_wait_"):
            itunes_index = int(data.split("_")[-1])
            itunes_order = pending_itunes_orders[itunes_index]
            context.bot.send_message(
                chat_id=itunes_order['user_id'],
                text="ุณูู ูุชู ุงุฑุณุงู ููุฏ ุงููุฏุงูุง ูุฑูุจุง"
            )
            btns = [[InlineKeyboardButton("ุฑุฌูุน", callback_data="pending_itunes_orders")]]
            query.edit_message_text("ุชู ุฅุฑุณุงู ุฅุดุนุงุฑ ุงูุงูุชุธุงุฑ ูููุณุชุฎุฏู.", reply_markup=InlineKeyboardMarkup(btns))
            return

        if data.startswith("itunes_complete_"):
            itunes_index = int(data.split("_")[-1])
            itunes_order = pending_itunes_orders[itunes_index]
            btns = [[InlineKeyboardButton("ุฑุฌูุน", callback_data="pending_itunes_orders")]]
            query.edit_message_text(
                "ุฃุฑุณู ุงูุขู ููุฏ ุงููุฏุงูุง ุงูุงูุชููุฒ:",
                reply_markup=InlineKeyboardMarkup(btns)
            )
            context.user_data["itunes_to_complete"] = itunes_order
            context.user_data["itunes_to_complete_index"] = itunes_index
            context.user_data["waiting_for_itunes_code"] = True
            return

        if data.startswith("itunes_cancel_"):
            itunes_index = int(data.split("_")[-1])
            itunes_order = pending_itunes_orders.pop(itunes_index)
            users_balance[itunes_order['user_id']] += itunes_order['price']
            sync_balance_to_db(itunes_order['user_id'])
            context.bot.send_message(
                chat_id=itunes_order['user_id'],
                text="ุชู ุฅูุบุงุก ุทูุจ ุดุญู ุงูุงูุชููุฒ ูุฅุนุงุฏุฉ ุงููุจูุบ ูุฑุตูุฏู."
            )
            btns = [[InlineKeyboardButton("ุฑุฌูุน", callback_data="pending_itunes_orders")]]
            query.edit_message_text(
                "ุชู ุฅูุบุงุก ุทูุจ ุดุญู ุงูุงูุชููุฒ ูุฅุนุงุฏุฉ ุงููุจูุบ ูููุณุชุฎุฏู.",
                reply_markup=InlineKeyboardMarkup(btns)
            )
            return

    ####################################
    # ุฃูุงูุฑ ุงููุณุชุฎุฏู ุงูุนุงุฏู
    ####################################
    else:
        if data == "show_followers":
            followers_services = {k: v for k, v in services_dict.items() if "ูุชุงุจุนูู" in k}
            service_buttons = [
                [InlineKeyboardButton(f"{sn} - {pr}$", callback_data=f"service_{sn}")]
                for sn, pr in followers_services.items()
            ]
            service_buttons.append([InlineKeyboardButton("ุฑุฌูุน", callback_data="show_services")])
            query.edit_message_text("ุงุฎุชุฑ ุงูุฎุฏูุฉ ุงููุทููุจุฉ:", reply_markup=InlineKeyboardMarkup(service_buttons))
            return

        elif data == "show_likes":
            likes_services = {k: v for k, v in services_dict.items() if "ูุงููุงุช" in k}
            service_buttons = [
                [InlineKeyboardButton(f"{sn} - {pr}$", callback_data=f"service_{sn}")]
                for sn, pr in likes_services.items()
            ]
            service_buttons.append([InlineKeyboardButton("ุฑุฌูุน", callback_data="show_services")])
            query.edit_message_text("ุงุฎุชุฑ ุงูุฎุฏูุฉ ุงููุทููุจุฉ:", reply_markup=InlineKeyboardMarkup(service_buttons))
            return

        elif data == "show_views":
            views_services = {
                k: v for k, v in services_dict.items() if "ูุดุงูุฏุงุช ุชููุชูู" in k or "ูุดุงูุฏุงุช ุงูุณุชุบุฑุงู" in k
            }
            service_buttons = [
                [InlineKeyboardButton(f"{sn} - {pr}$", callback_data=f"service_{sn}")]
                for sn, pr in views_services.items()
            ]
            service_buttons.append([InlineKeyboardButton("ุฑุฌูุน", callback_data="show_services")])
            query.edit_message_text("ุงุฎุชุฑ ุงูุฎุฏูุฉ ุงููุทููุจุฉ:", reply_markup=InlineKeyboardMarkup(service_buttons))
            return

        elif data == "show_live_views":
            live_views_services = {
                k: v for k, v in services_dict.items() if "ูุดุงูุฏุงุช ุจุซ" in k
            }
            service_buttons = [
                [InlineKeyboardButton(f"{sn} - {pr}$", callback_data=f"service_{sn}")]
                for sn, pr in live_views_services.items()
            ]
            service_buttons.append([InlineKeyboardButton("ุฑุฌูุน", callback_data="show_services")])
            query.edit_message_text("ุงุฎุชุฑ ุงูุฎุฏูุฉ ุงููุทููุจุฉ:", reply_markup=InlineKeyboardMarkup(service_buttons))
            return

        elif data == "show_pubg":
            service_buttons = []
            for service_name, price in pubg_services.items():
                btn_text = f"{service_name} - {price}$"
                service_buttons.append(
                    [InlineKeyboardButton(btn_text, callback_data=f"pubg_service_{service_name}")]
                )
            service_buttons.append([InlineKeyboardButton("ุฑุฌูุน", callback_data="show_services")])
            query.edit_message_text("ุงุฎุชุฑ ุฎุฏูุฉ ุดุญู ุดุฏุงุช ุจุจุฌู:", reply_markup=InlineKeyboardMarkup(service_buttons))
            return

        elif data.startswith("pubg_service_"):
            service_name = data[len("pubg_service_"):]
            price = pubg_services.get(service_name, 0)
            current_balance = users_balance.get(user_id, 0.0)

            if current_balance < price:
                buttons = [
                    [InlineKeyboardButton("ุดุญู ุนุจุฑ ุงุณูุงุณูู", callback_data="charge_asiacell")],
                    [InlineKeyboardButton("ุฑุฌูุน", callback_data="show_pubg")]
                ]
                query.edit_message_text("ุฑุตูุฏู ููุณ ูุงููุงู.", reply_markup=InlineKeyboardMarkup(buttons))
                return

            context.user_data["selected_pubg_service"] = service_name
            context.user_data["pubg_service_price"] = price
            query.edit_message_text("ุงุฑุณู ุงูุงูุฏู ุงูุฎุงุต ุจู:")
            return

        elif data == "show_itunes_services":
            query.edit_message_text("ุงุฎุชุฑ ุงูุฎุฏูุฉ ุงููุทููุจุฉ:", reply_markup=itunes_services_keyboard())
            return

        elif data.startswith("itunes_service_"):
            service_name = data[len("itunes_service_"):]
            price = itunes_services.get(service_name, 0)
            current_balance = users_balance.get(user_id, 0.0)

            if current_balance < price:
                buttons = [
                    [InlineKeyboardButton("ุดุญู ุนุจุฑ ุงุณูุงุณูู", callback_data="charge_asiacell")],
                    [InlineKeyboardButton("ุฑุฌูุน", callback_data="show_itunes_services")]
                ]
                query.edit_message_text("ุฑุตูุฏู ููุณ ูุงููุงู.", reply_markup=InlineKeyboardMarkup(buttons))
                return

            context.user_data["selected_itunes_service"] = service_name
            context.user_data["itunes_service_price"] = price
            query.edit_message_text(
                f"ุชู ุงุฎุชูุงุฑ ุงูุฎุฏูุฉ: {service_name}\n\n"
                "ุงุฑุณู ุฑูู 1 ูุชุฃููุฏ ุทูุจู"
            )
            context.user_data["waiting_for_itunes_confirm"] = True
            return

        elif data == "show_telegram_services":
            query.edit_message_text("ุงุฎุชุฑ ุงูุฎุฏูุฉ ุงููุทููุจุฉ:", reply_markup=telegram_services_keyboard())
            return

        elif data.startswith("telegram_service_"):
            service_name = data[len("telegram_service_"):]
            price = telegram_services.get(service_name, 0)
            current_balance = users_balance.get(user_id, 0.0)

            if current_balance < price:
                buttons = [
                    [InlineKeyboardButton("ุดุญู ุนุจุฑ ุงุณูุงุณูู", callback_data="charge_asiacell")],
                    [InlineKeyboardButton("ุฑุฌูุน", callback_data="show_telegram_services")]
                ]
                query.edit_message_text("ุฑุตูุฏู ููุณ ูุงููุงู.", reply_markup=InlineKeyboardMarkup(buttons))
                return

            context.user_data["selected_telegram_service"] = service_name
            context.user_data["telegram_service_price"] = price
            context.user_data["waiting_for_telegram_link"] = True

            note_text = (
                "ุงูุฑุฌุงุก ุฅุฑุณุงู ุฑุงุจุท ุฏุนูุฉ ุงูุถูุงู ูููุณ ุฑุงุจุท ุงูููุงุฉ ุฃู ุงุณู ุงููุณุชุฎุฏู (ูุซู: https://t.me/+xxxx).\n\n"
                "ุฎุทูุงุช ุฅูุดุงุก ุฑุงุจุท ุงูุฏุนูุฉ ุงูุฎุงุต:\n"
                "1. ุงุฏุฎู ุฅูู ุงูููุงุฉ.\n"
                "2. ุงุฎุชุฑ ุฎูุงุฑ ุงููุดุชุฑููู.\n"
                "3. ุงุถุบุท ุนูู ุงูุฏุนูุฉ ุนุจุฑ ุฑุงุจุท ุฎุงุต.\n"
                "4. ุฃูุดุฆ ุฑุงุจุท ุฏุนูุฉ ุฌุฏูุฏ."
            )
            query.edit_message_text(note_text)
            return

        elif data == "show_balance":
            balance = users_balance.get(user_id, 0.0)
            buttons = [
                [InlineKeyboardButton("ุดุญู ุนุจุฑ ุงุณูุงุณูู", callback_data="charge_asiacell")],
                [InlineKeyboardButton("ุฑุฌูุน", callback_data="back_main")]
            ]
            query.edit_message_text(f"ุฑุตูุฏู ุงูุญุงูู: {balance}$", reply_markup=InlineKeyboardMarkup(buttons))
            return

        elif data == "charge_asiacell":
            context.user_data["waiting_for_card"] = True
            query.edit_message_text("ุฃุฑุณู ุฑูู ุงููุงุฑุช ุงููููู ูู 14 ุฑูู ุฃู 16 ุฑูู:")
            return

###############################################################################
# ุงูุฏุงูุฉ ุงููุณุคููุฉ ุนู ุงุณุชูุจุงู ุฑุณุงุฆู ุงููุตูุต ูุงูุตูุฑ ูุงูููุฏูู... (MessageHandler)
###############################################################################
def handle_messages(update: Update, context: CallbackContext):
    """ุงูุฏุงูุฉ ุงููุณุคููุฉ ุนู ูุนุงูุฌุฉ ุฑุณุงุฆู ุงูุฏุฑุฏุดุฉ ุงูุนุงูุฉ (ูุต/ุตูุฑุฉ/ููุฏูู/ุตูุช)."""
    user_id = update.effective_user.id
    text_msg = update.message.text if update.message.text else ""

    # ููุน ุงููุญุธูุฑูู
    if user_id in blocked_users and user_id != ADMIN_ID:
        update.message.reply_text("ููุฏ ุชู ุญุถุฑู ูู ุงุณุชุฎุฏุงู ุงูุจูุช ๐คฃ.\nุงูุชุธุฑ ุญุชู ูุชู ุงูุบุงุก ุญุธุฑู.")
        return

    # ุฅุถุงูุฉ ุงูุฑุตูุฏ ูู ูุจู ุงููุงูู
    if user_id == ADMIN_ID and context.user_data.get("waiting_for_add_balance_user_id"):
        target_input = text_msg.strip()
        try:
            target_id = int(target_input)
        except ValueError:
            found_user = None
            for usr in get_all_users():
                if usr[2] and usr[2].lower() == target_input.lower():
                    found_user = usr
                    break
            if not found_user:
                update.message.reply_text("ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.")
                return
            target_id = found_user[0]

        context.user_data["admin_target_id"] = target_id
        context.user_data["waiting_for_add_balance_user_id"] = False
        context.user_data["waiting_for_add_balance_amount"] = True
        update.message.reply_text("ุฃุฑุณู ุงูุขู ุงููุจูุบ ุงููุฑุงุฏ ุฅุถุงูุชู ุฅูู ุฑุตูุฏ ุงููุณุชุฎุฏู:")
        return

    if user_id == ADMIN_ID and context.user_data.get("waiting_for_discount_user_id"):
        target_input = text_msg.strip()
        try:
            target_id = int(target_input)
        except ValueError:
            found_user = None
            for usr in get_all_users():
                if usr[2] and usr[2].lower() == target_input.lower():
                    found_user = usr
                    break
            if not found_user:
                update.message.reply_text("ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.")
                return
            target_id = found_user[0]

        context.user_data["admin_target_id"] = target_id
        context.user_data["waiting_for_discount_user_id"] = False
        context.user_data["waiting_for_discount_amount"] = True
        update.message.reply_text("ุฃุฑุณู ุงูุขู ุงููุจูุบ ุงููุฑุงุฏ ุฎุตูู ูู ุฑุตูุฏ ุงููุณุชุฎุฏู:")
        return

    if user_id == ADMIN_ID and context.user_data.get("waiting_for_add_balance_amount"):
        amount_str = text_msg.strip()
        try:
            amount = float(amount_str)
        except ValueError:
            update.message.reply_text("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฑูู ุตุงูุญ ูููุจูุบ.")
            return

        target_id = context.user_data.pop("admin_target_id", None)
        context.user_data["waiting_for_add_balance_amount"] = False
        if target_id is None:
            update.message.reply_text("ุญุฏุซ ุฎุทุฃ: ูุง ููุฌุฏ ูุณุชุฎุฏู ูุณุชูุฏู.")
            return

        current_balance = users_balance.get(target_id, 0.0)
        new_balance = current_balance + amount
        users_balance[target_id] = new_balance
        sync_balance_to_db(target_id)

        update.message.reply_text(
            f"ุชูุช ุฅุถุงูุฉ {amount}$ ุฅูู ุฑุตูุฏ ุงููุณุชุฎุฏู (ID: {target_id}). ุงูุฑุตูุฏ ุงูุฌุฏูุฏ: {new_balance}$."
        )
        context.bot.send_message(
            chat_id=target_id,
            text=f"ุชูุจูู: ุชูุช ุฅุถุงูุฉ {amount}$ ุฅูู ุญุณุงุจู. ุฑุตูุฏู ุงูุฌุฏูุฏ: {new_balance}$."
        )
        return

    if user_id == ADMIN_ID and context.user_data.get("waiting_for_discount_amount"):
        amount_str = text_msg.strip()
        try:
            amount = float(amount_str)
        except ValueError:
            update.message.reply_text("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฑูู ุตุงูุญ ูููุจูุบ.")
            return

        target_id = context.user_data.pop("admin_target_id", None)
        context.user_data["waiting_for_discount_amount"] = False
        if target_id is None:
            update.message.reply_text("ุญุฏุซ ุฎุทุฃ: ูุง ููุฌุฏ ูุณุชุฎุฏู ูุณุชูุฏู.")
            return

        current_balance = users_balance.get(target_id, 0.0)
        if current_balance < amount:
            update.message.reply_text("ุงููุณุชุฎุฏู ููุณ ูุฏูู ุฑุตูุฏ ูุงูู ููุฎุตู.")
            return

        new_balance = current_balance - amount
        users_balance[target_id] = new_balance
        sync_balance_to_db(target_id)

        update.message.reply_text(
            f"ุชู ุฎุตู {amount}$ ูู ุฑุตูุฏ ุงููุณุชุฎุฏู (ID: {target_id}). ุงูุฑุตูุฏ ุงูุฌุฏูุฏ: {new_balance}$."
        )
        context.bot.send_message(
            chat_id=target_id,
            text=f"ุชูุจูู: ุชู ุฎุตู {amount}$ ูู ุญุณุงุจู. ุฑุตูุฏู ุงูุฌุฏูุฏ: {new_balance}$."
        )
        return

    if user_id == ADMIN_ID and context.user_data.get("waiting_for_amount"):
        amount_str = text_msg.strip()
        try:
            amount = float(amount_str)
        except ValueError:
            update.message.reply_text("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฑูู ุตุงูุญ ูููุจูุบ.")
            return

        card_info = context.user_data.pop("card_to_approve", None)
        card_index = context.user_data.pop("card_to_approve_index", None)
        context.user_data["waiting_for_amount"] = False

        if card_info is None or card_index is None:
            update.message.reply_text("ุญุฏุซ ุฎุทุฃ: ูุง ููุฌุฏ ูุงุฑุช ูุนูู ูุณุชูุฏู.")
            return

        target_id = card_info["user_id"]
        current_balance = users_balance.get(target_id, 0.0)
        new_balance = current_balance + amount
        users_balance[target_id] = new_balance
        sync_balance_to_db(target_id)

        try:
            pending_cards.pop(card_index)
        except IndexError:
            update.message.reply_text("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุฒุงูุฉ ุงููุงุฑุช ูู ุงููุงุฆูุฉ.")
            return

        update.message.reply_text(
            f"ุชู ุดุญู ุฑุตูุฏ ุงููุณุชุฎุฏู ุจููุฏุงุฑ {amount}$ ุจูุฌุงุญ. ุงูุฑุตูุฏ ุงูุฌุฏูุฏ: {new_balance}$."
        )
        context.bot.send_message(
            chat_id=target_id,
            text=f"ุชูุจูู: ุชู ุดุญู ุฑุตูุฏู ุจููุฏุงุฑ {amount}$ ุจูุฌุงุญ."
        )
        return

    if context.user_data.get("waiting_for_block") and user_id == ADMIN_ID:
        block_str = text_msg.strip()
        context.user_data["waiting_for_block"] = False

        try:
            target_id = int(block_str)
        except ValueError:
            found_user = None
            for usr in get_all_users():
                if usr[2] and usr[2].lower() == block_str.lower():
                    found_user = usr
                    break
            if not found_user:
                update.message.reply_text("ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.")
                return
            target_id = found_user[0]

        blocked_users[target_id] = True
        update.message.reply_text(f"ุชู ุญุถุฑ ุงููุณุชุฎุฏู ุจูุฌุงุญ. (ID: {target_id})")
        return

    if context.user_data.get("waiting_for_broadcast") and user_id == ADMIN_ID:
        context.user_data["waiting_for_broadcast"] = False
        broadcast_ad(update, context)
        return

    if context.user_data.get("waiting_for_card"):
        card_str = text_msg.strip()
        # ุงูุชุญูู ูู ุตุญุฉ ุทูู ุงููุงุฑุช
        if card_str and (len(card_str) == 14 or len(card_str) == 16) and card_str.isdigit():
            context.user_data["waiting_for_card"] = False

            full_name = update.effective_user.full_name
            username = update.effective_user.username or "NoUsername"

            new_card = {
                "user_id": user_id,
                "full_name": full_name,
                "username": username,
                "card_number": card_str
            }
            pending_cards.append(new_card)
            update.message.reply_text("ุชู ุงุณุชูุงู ุฑูู ุงููุงุฑุช ุจูุฌุงุญุ ุณูููู ุจุงููุฑุงุฌุนุฉ ูุฑูุจุงู.")
            context.bot.send_message(
                chat_id=ADMIN_ID,
                text="ููุงู ุทูุจ ุดุญู ุฌุฏูุฏ ูู ุงููุงุฑุชุงุช ุงููุนููุฉ."
            )
        else:
            update.message.reply_text("ุงูุฑูู ุงููุฏุฎู ุบูุฑ ุตุญูุญ. ุชุฃููุฏ ุฃูู ููููู ูู 14 ุฃู 16 ุฑูู.")
        return

    if context.user_data.get("waiting_for_api_order_status") and user_id == ADMIN_ID:
        order_id = text_msg.strip()
        context.user_data["waiting_for_api_order_status"] = False

        params = {'key': API_KEY, 'action': 'status', 'order': order_id}
        try:
            response = requests.post(API_URL, data=params)
            order_status = response.json()
            if "status" in order_status:
                message = (
                    f"๐ ุฑูู ุงูุทูุจ: {order_status.get('order', order_id)}\n"
                    f"๐ ุงูุชุงุฑูุฎ: {order_status.get('date', 'ุบูุฑ ูุชููุฑ')}\n"
                    f"๐ ุงูุฑุงุจุท: {order_status.get('link', 'ุบูุฑ ูุชููุฑ')}\n"
                    f"๐ฐ ุงูุชูููู: {order_status.get('cost', 'ุบูุฑ ูุชููุฑ')}$\n"
                    f"๐ข ุนุฏุฏ ุงูุจุฏุงูุฉ: {order_status.get('start_count', 'ุบูุฑ ูุชููุฑ')}\n"
                    f"๐ ุงููุชุจูู: {order_status.get('remains', 'ุบูุฑ ูุชููุฑ')}"
                )
                update.message.reply_text(message)
            else:
                update.message.reply_text(
                    f"โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุญุงูุฉ ุงูุทูุจ: {order_status.get('error', 'ุฎุทุฃ ุบูุฑ ูุนุฑูู')}"
                )
        except Exception:
            update.message.reply_text("โ ูุดู ุงูุงุชุตุงู ุจุงููุธุงู ุงูุฎุงุฑุฌู. ุญุงูู ูุฑุฉ ุฃุฎุฑู ูุงุญูุงู.")
        return

    # ุงุณุชูุงู ุฑุงุจุท ุงูุฎุฏูุฉ
    if "selected_service" in context.user_data and "service_price" in context.user_data:
        link_text = text_msg.strip()
        if not link_text:
            update.message.reply_text("ุงูุฑุฌุงุก ุฅุฑุณุงู ุงูุฑุงุจุท ููุต ููุท.")
            return

        service_name = context.user_data.pop("selected_service")
        price = context.user_data.pop("service_price")

        # ุฎุตู ุงูุฑุตูุฏ
        users_balance[user_id] -= price
        sync_balance_to_db(user_id)

        # ุชูููุฐ ุงูุฎุฏูุฉ ุฅู ูุงูุช ูู mappingุ ูุฅูุง ุชูุฎุฒู ูู ุงููุนูู
        if service_name in service_api_mapping:
            mapping = service_api_mapping[service_name]
            quantity = mapping["quantity_multiplier"]

            params = {
                'key': API_KEY,
                'action': 'add',
                'service': mapping["service_id"],
                'link': link_text,
                'quantity': quantity
            }
            try:
                api_response = requests.post(API_URL, data=params).json()
            except Exception:
                api_response = {"error": "ูุดู ุงุณุชุฏุนุงุก API"}

            if "order" in api_response:
                update.message.reply_text(
                    f"ุชู ุงุณุชูุงู ุทูุจู ูุณูู ูุชู ุชูููุฐู ูุฑูุจุงู\nุฑูู ุทูุจู ({api_response['order']})"
                )
            else:
                # ูุดู ุงูุชูููุฐ -> ุงุณุชุนุงุฏุฉ ุงูุฑุตูุฏ
                users_balance[user_id] += price
                sync_balance_to_db(user_id)
                update.message.reply_text("ูุดู ุชูููุฐ ุงูุทูุจ ุนุจุฑ ุงููุธุงู ุงูุฎุงุฑุฌูุ ุชูุช ุฅุนุงุฏุฉ ุงููุจูุบ ูุฑุตูุฏู.")
        else:
            new_order = {
                "user_id": user_id,
                "full_name": update.effective_user.full_name,
                "username": update.effective_user.username or "NoUsername",
                "service": service_name,
                "price": price,
                "link": link_text
            }
            pending_orders.append(new_order)
            update.message.reply_text("ุชู ุชุฃููุฏ ุทูุจู ูุฎุตู ุงููุจูุบ ูู ุฑุตูุฏู. ุณูุชู ุชูููุฐ ุงูุทูุจ ูุฑูุจุงู.")
            context.bot.send_message(
                chat_id=ADMIN_ID,
                text="ููุงู ุทูุจ ุฑุดู ุฌุฏูุฏ ูู ุงูุทูุจุงุช ุงููุนููุฉ."
            )
        return

    # ุงุณุชูุงู ุขูุฏู ุจุจุฌู
    if "selected_pubg_service" in context.user_data and "pubg_service_price" in context.user_data:
        pubg_id_text = text_msg.strip()
        service_name = context.user_data.pop("selected_pubg_service")
        price = context.user_data.pop("pubg_service_price")

        if not pubg_id_text:
            update.message.reply_text("ุงูุฑุฌุงุก ุฅุฑุณุงู ุงูุขูุฏู ููุต ููุท.")
            return

        # ุฎุตู ุงูุฑุตูุฏ
        users_balance[user_id] -= price
        sync_balance_to_db(user_id)

        new_pubg_order = {
            "user_id": user_id,
            "full_name": update.effective_user.full_name,
            "username": update.effective_user.username or "NoUsername",
            "service": service_name,
            "price": price,
            "pubg_id": pubg_id_text
        }
        pending_pubg_orders.append(new_pubg_order)
        update.message.reply_text(
            "ุชู ุชุฃููุฏ ุทูุจ ุดุญู ุดุฏุงุช ุจุจุฌู ูุฎุตู ุงููุจูุบ ูู ุฑุตูุฏู.\n"
            "ุณูุชู ุฅุจูุงุบู ุนูุฏ ุดุญู ุงูุดุฏุงุช ุฃู ุฅูุบุงุฆูุง."
        )
        context.bot.send_message(
            chat_id=ADMIN_ID,
            text="ููุงู ุทูุจ ุดุญู ุดุฏุงุช ูู ูุณู ุงูุดุฏุงุช ุงููุนููุฉ"
        )
        return

    # ุชุฃููุฏ ุทูุจ ุงูุชููุฒ
    if context.user_data.get("waiting_for_itunes_confirm"):
        if text_msg.strip() == "1":
            service_name = context.user_data.pop("selected_itunes_service")
            price = context.user_data.pop("itunes_service_price")
            context.user_data["waiting_for_itunes_confirm"] = False

            current_balance = users_balance.get(user_id, 0.0)
            if current_balance < price:
                update.message.reply_text("ุฑุตูุฏู ุบูุฑ ูุงููุ ูู ุจุงูุดุญู ุฃููุงู.")
                return

            users_balance[user_id] -= price
            sync_balance_to_db(user_id)

            new_itunes_order = {
                "user_id": user_id,
                "full_name": update.effective_user.full_name,
                "username": update.effective_user.username or "NoUsername",
                "service": service_name,
                "price": price
            }
            pending_itunes_orders.append(new_itunes_order)
            update.message.reply_text("ุชู ุชุฃููุฏ ุทูุจ ุดุฑุงุก ุฑุตูุฏ ุงูุชููุฒ.\nุณูุชู ุฅุจูุงุบู ุนูุฏ ูุนุงูุฌุฉ ุงูุทูุจ.")
            context.bot.send_message(
                chat_id=ADMIN_ID,
                text="ููุงู ุทูุจ ุดุญู ุงูุชููุฒ ุฌุฏูุฏ ูู ูุณู ุงูุงูุชููุฒ ุงููุนููุฉ"
            )
        else:
            update.message.reply_text("ูู ูุชู ุชุฃููุฏ ุงูุทูุจ. ุฅุฐุง ุฃุฑุฏุช ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุงุฎุชุฑ ุงูุฎุฏูุฉ ูุฌุฏุฏุงู.")
        return

    # ุงุณุชูุงู ููุฏ ุงูุชููุฒ ูู ุงููุงูู
    if context.user_data.get("waiting_for_itunes_code") and user_id == ADMIN_ID:
        gift_code = text_msg.strip()
        context.user_data["waiting_for_itunes_code"] = False

        itunes_order = context.user_data.pop("itunes_to_complete", None)
        itunes_index = context.user_data.pop("itunes_to_complete_index", None)

        if not itunes_order or itunes_index is None:
            update.message.reply_text("ุญุฏุซ ุฎุทุฃ: ูุง ููุฌุฏ ุทูุจ ุงูุชููุฒ ูุญูุธ ุงูููุฏ ุนููู.")
            return

        pending_itunes_orders.pop(itunes_index)

        context.bot.send_message(
            chat_id=itunes_order['user_id'],
            text=f"ุชู ุชูููุฐ ุทูุจ ุดุฑุงุก ููุฏ ุงููุฏุงูุง.\nุงูููุฏ:\n`{gift_code}`",
            parse_mode="Markdown"
        )
        update.message.reply_text("ุชู ุฅุฑุณุงู ููุฏ ุงููุฏุงูุง ูููุณุชุฎุฏู ุจูุฌุงุญ.")
        return

    # ุงุณุชูุงู ุฑุงุจุท ุฏุนูุฉ ุงูุชููุฌุฑุงู
    if context.user_data.get("waiting_for_telegram_link"):
        context.user_data["waiting_for_telegram_link"] = False

        service_name = context.user_data.pop("selected_telegram_service")
        price = context.user_data.pop("telegram_service_price")
        link_invite = text_msg.strip()

        current_balance = users_balance.get(user_id, 0.0)
        if current_balance < price:
            update.message.reply_text("ุฑุตูุฏู ุบูุฑ ูุงูู. ุงุดุญู ุฃููุงู.")
            return

        users_balance[user_id] -= price
        sync_balance_to_db(user_id)

        # ุชุญุฏูุฏ ูููุฉ ุงูุฃุนุถุงุก
        quantity = 0
        if "1k" in service_name:
            quantity = 1000
        elif "2k" in service_name:
            quantity = 2000
        elif "3k" in service_name:
            quantity = 3000
        elif "4k" in service_name:
            quantity = 4000
        elif "5k" in service_name:
            quantity = 5000

        # ูุญุงููุฉ ุชูููุฐ ุงูุทูุจ ุนุจุฑ ุงูู API
        params = {
            'key': API_KEY,
            'action': 'add',
            'service': 12891,   # ุงูุฎุฏูุฉ ุงูุนุงูุฉ ูู SMM ูุฒูุงุฏุฉ ุฃุนุถุงุก ุงูููุงุฉ/ุงููุฑูุจ
            'link': link_invite,
            'quantity': quantity
        }
        try:
            api_response = requests.post(API_URL, data=params).json()
        except Exception:
            api_response = {"error": "ูุดู ุงุณุชุฏุนุงุก API"}

        if "order" in api_response:
            update.message.reply_text(
                f"ุชู ุงุณุชูุงู ุทูุจู ูุณูู ูุชู ุชูููุฐู ูุฑูุจุงู\nุฑูู ุทูุจู ({api_response['order']})"
            )
        else:
            users_balance[user_id] += price
            sync_balance_to_db(user_id)
            update.message.reply_text("ูุดู ุชูููุฐ ุงูุทูุจ ุนุจุฑ ุงููุธุงู ุงูุฎุงุฑุฌูุ ุชูุช ุฅุนุงุฏุฉ ุงููุจูุบ ูุฑุตูุฏู.")
        return

    # ูู ุญุงู ุฃุฑุณู ุงููุงูู ูุณุงุฆุท (ุตูุฑุฉ/ููุฏูู/ุตูุช) ุฃุซูุงุก ูุถุน ุงูุจุซ
    if user_id == ADMIN_ID and (update.message.photo or update.message.video or update.message.voice):
        if context.user_data.get("waiting_for_broadcast"):
            # ุฅุฑุณุงู ุฅุนูุงู ูุฌููุน ุงููุณุชุฎุฏููู
            context.user_data["waiting_for_broadcast"] = False
            broadcast_ad(update, context)
            return


###############################################################################
# ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ (main)
###############################################################################
def main():
    """ุชุฌููุฒ ุงูุจูุช ูุชุดุบููู."""
    updater = Updater(TOKEN, use_context=True)
    dp = updater.dispatcher

    # ุฃูุงูุฑ
    dp.add_handler(CommandHandler("start", start))

    # ุงูุฃุฒุฑุงุฑ ุงูุชูุงุนููุฉ
    dp.add_handler(CallbackQueryHandler(button_handler))

    # ุฑุณุงุฆู ุนุงูุฉ (ูุต ุฃู ูุณุงุฆุท)
    dp.add_handler(MessageHandler(Filters.text & ~Filters.command, handle_messages))
    dp.add_handler(MessageHandler(Filters.photo | Filters.video | Filters.voice, handle_messages))

    # ุจุฏุก ุงูุณุญุจ ูุงูุงุณุชูุงุน
    updater.start_polling()
    updater.idle()


if __name__ == "__main__":
    main()
